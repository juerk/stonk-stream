<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stonk.Stream</title>

  <!-- HLS.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <!-- Solana Web3.js -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>

  <style>
    body { margin:0; height:100vh; display:flex; flex-direction:column; background:#0b3d0b; color:#d4f1be; font-family:'Segoe UI',sans-serif; overflow:hidden; }
    .ticker { height:2rem; background:rgba(0,0,0,0.5); display:flex; align-items:center; overflow:hidden; }
    .ticker__content { white-space:nowrap; padding-left:100%; animation:scrollTicker 20s linear infinite; color:#e0ffb3; font-weight:bold; }
    @keyframes scrollTicker{from{transform:translateX(0)}to{transform:translateX(-100%)}}
    #mainContent { flex:1; display:flex; }
    #playerWrapper { position:relative; width:75%; background:#000; }
    video { width:100%; height:100%; object-fit:cover; }
    #viewCount { position:absolute; bottom:0.5rem; left:0.5rem; background:rgba(255,255,255,0.8); padding:0.25rem 0.5rem; border-radius:4px; display:flex; align-items:center; color:#388e3c; }
    #viewNum{margin-left:0.25rem;font-weight:bold;}
    #volumeControls{position:absolute;bottom:0.5rem;right:0.5rem;display:flex;gap:0.5rem;}
    #chatContainer{width:25%;display:flex;flex-direction:column;background:#264d26;border-left:2px solid #1b3a1b;}
    #connectContainer{padding:0.5rem;background:#1b3a1b;display:flex;align-items:center;gap:0.5rem;}
    #connectWalletBtn{padding:0.4rem 0.8rem;background:#66bb6a;border:none;border-radius:4px;cursor:pointer;color:#111;}
    #walletAddress{font-family:monospace;font-size:0.8rem;color:#c5e1a5;}
    #chatLog{flex:1;padding:0.5rem;background:#1b3a1b;overflow-y:auto;}
    .chat-name{font-weight:bold;color:#ff5555;margin-right:0.25rem;}
    #messageControls{display:flex;padding:0.5rem;border-top:1px solid #444;background:#2e7d32;}
    #messageControls input{flex:1;padding:0.4rem;border:none;background:#1b3a1b;color:#d4f1be;}
    #messageControls button{padding:0.4rem 0.8rem;background:#43a047;border:none;color:#fff;cursor:pointer;margin-left:0.5rem;}
  </style>
</head>
<body>
  <div class="ticker">
    <div class="ticker__content">WELCOME TO ðŸŽ¥ðŸ“ˆSTONK.STREAMðŸ“‰ðŸŽ¥ ðŸ”´ LIVE NOW â€¢ Wuerk ðŸ”´ Watch me in my natural habitat, do not feed the animal â€¢ ðŸ’µ</div>
  </div>
  <div id="mainContent">
    <div id="playerWrapper">
      <video id="video" controls autoplay muted></video>
      <div id="viewCount"><span>ðŸ‘¤</span><span id="viewNum">0</span></div>
      <div id="volumeControls"><input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1"><button id="muteBtn">ðŸ”Š</button></div>
    </div>
    <div id="chatContainer">
      <div id="connectContainer">
        <button id="connectWalletBtn">ðŸ”— Connect Wallet</button>
        <span id="walletAddress"></span>
      </div>
      <div id="chatLog"></div>
      <div id="messageControls">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button id="sendMsgBtn">Send</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // HLS.js playback
      const video = document.getElementById('video');
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource('https://stonk.stream/hls/mystream.m3u8');
        hls.attachMedia(video);
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = 'https://stonk.stream/hls/mystream.m3u8';
      }

      // Volume/mute
      const slider = document.getElementById('volumeSlider'), muteBtn = document.getElementById('muteBtn');
      slider.oninput = () => { video.volume = slider.value; };
      muteBtn.onclick = () => { video.muted = !video.muted; muteBtn.textContent = video.muted ? 'ðŸ”‡' : 'ðŸ”Š'; };

      // Wallet + Username
      const connectBtn = document.getElementById('connectWalletBtn'), addrSpan = document.getElementById('walletAddress');
      let username = null;
      if (window.solana && window.solana.isPhantom) {
        connectBtn.onclick = async () => {
          try {
            const res = await window.solana.connect();
            const key = res.publicKey.toString();
            // prompt for username tied to wallet
            username = localStorage.getItem('user_' + key) || prompt('Choose a username:') || 'Guest';
            localStorage.setItem('user_' + key, username);
            // update button text to username
            connectBtn.textContent = username;
            addrSpan.textContent = key;
          } catch {
            alert('Wallet connect failed');
          }
        };
      } else {
        connectBtn.textContent = 'Install Phantom';
        connectBtn.onclick = () => window.open('https://phantom.app/', '_blank');
      }

      // Viewer count
      const sid = sessionStorage.getItem('sid') || crypto.randomUUID();
      sessionStorage.setItem('sid', sid);
      navigator.sendBeacon(`/api/viewers?join=1&session=${sid}`);
      window.addEventListener('beforeunload', () => {
        navigator.sendBeacon(`/api/viewers?join=0&session=${sid}`);
      });
      async function updView() {
        try {
          const res = await fetch('/api/viewers/count');
          const d = await res.json();
          document.getElementById('viewNum').textContent = d.viewers;
        } catch {}
      }
      updView(); setInterval(updView, 5000);

      // Chat functionality
      const chatLog = document.getElementById('chatLog');
      const msgIn = document.getElementById('messageInput');
      document.getElementById('sendMsgBtn').onclick = () => {
        if (!username) return alert('Connect wallet and choose username first');
        const msg = msgIn.value.trim(); if (!msg) return;
        const div = document.createElement('div');
        const span = document.createElement('span');
        span.textContent = username + ': ';
        span.classList.add('chat-name');
        div.appendChild(span);
        div.appendChild(document.createTextNode(msg));
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;
        msgIn.value = '';
      };
      msgIn.addEventListener('keypress', e => {
        if (e.key === 'Enter') document.getElementById('sendMsgBtn').click();
      });
    });
  </script>
</body>
</html>
